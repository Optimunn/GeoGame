#!/bin/bash

APP_VERSION="0.6.0"
APP_NAME="Geographical game"
BIN_NAME="geo_game"
BINARY_PATH="../target/release/$BIN_NAME"
ICON_PATH="./icon/geogame.png"
OUTPUT_DIR="./"

cargo_check() {
    if cargo --version > /dev/null 2>&1; then
        echo "Cargo OK."
    else
        echo "Error: Cargo is not installed!"
        exit 1
    fi
}

APP_DIR="$OUTPUT_DIR/$APP_NAME.app"

if [ "$1" = "--clear" ] || [ "$1" = "-c" ]; then
    if [ -d "$APP_DIR" ]; then
        echo "Deleting previous version..."
        rm -rf "$APP_DIR"
    fi
    exit 0
elif [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    echo "Options:"
    echo "  --clear, -c    Clear previous version"
    echo "  --help, -h     Print this help message"
    echo "  --release      Build release binary"
    echo "  --all          Build release application"
    echo "  (no options)   Build app and activate it"
    exit 0
elif [ "$1" = "--release" ]; then
    cargo_check
    echo "Build release binary..."
    cargo build --release
    if [ $? -ne 0 ]; then
        exit 1
    fi
    exit 0
elif [ "$1" = "--all" ]; then
    cargo_check
    echo "Build release application..."
    cargo build --release
    if [ $? -ne 0 ]; then
        exit 1
    fi
elif [ "$1" != "" ]; then
    echo "Unknown option: $1"
    echo "Use --help or -h for help"
    exit 1
fi

check_file_exists() {
    if [ ! -f "$1" ]; then
        echo "Error: File not found: $1"
        exit 1
    fi
}

check_file_exists "$BINARY_PATH"
check_file_exists "$ICON_PATH"

CONTENTS_DIR="$APP_DIR/Contents"
MACOS_DIR="$CONTENTS_DIR/MacOS"

APP_BIN_NAME="main"

if [ -e "$MACOS_DIR/$APP_BIN_NAME" ]; then
    echo "Changing binary file..."
    cp "$BINARY_PATH" "$MACOS_DIR/$APP_BIN_NAME"
    chmod +x "$MACOS_DIR/$APP_BIN_NAME"
    echo "Application successfully recreated: $APP_DIR"
    echo "Size: $(du -sh "$APP_DIR" | cut -f1)"
    exit 0
fi

if [ -d "$APP_DIR" ]; then
    echo "Deleting previous version..."
    rm -rf "$APP_DIR"
fi

RESOURCES_DIR="$CONTENTS_DIR/Resources"
RESOURCES_DIR_DATA="$RESOURCES_DIR/Data"

ASSETS_DIR="$RESOURCES_DIR/Assets"
ASSETS_DIR_FLAGS="$ASSETS_DIR/flags"
ASSETS_DIR_ICONS="$ASSETS_DIR/icons"

echo "Creating directory structure..."
mkdir -p "$MACOS_DIR"
mkdir -p "$RESOURCES_DIR"
mkdir -p "$RESOURCES_DIR_DATA"
mkdir -p "$ASSETS_DIR"
mkdir -p "$ASSETS_DIR_FLAGS"
mkdir -p "$ASSETS_DIR_ICONS"

IMG_PATH="../assets/flags/4x3/."
ICS_PATH="../assets/icons/."
DATA_PATH="../data/."

echo "Copying files..."
cp "$BINARY_PATH" "$MACOS_DIR/$APP_BIN_NAME"
chmod +x "$MACOS_DIR/$APP_BIN_NAME"

cp "$ICON_PATH" "$RESOURCES_DIR/AppIcon.png"
cp -a "$IMG_PATH" "$ASSETS_DIR_FLAGS/"
cp -a "$ICS_PATH" "$ASSETS_DIR_ICONS/"
cp -a "$DATA_PATH" "$RESOURCES_DIR_DATA/"

echo "Creating Info.plist..."
cat > "$CONTENTS_DIR/Info.plist" << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleExecutable</key>
    <string>$APP_BIN_NAME</string>
    <key>CFBundleIdentifier</key>
    <string>com.AlexIlush.$APP_NAME</string>
    <key>CFBundleName</key>
    <string>$APP_NAME</string>
    <key>CFBundleVersion</key>
    <string>$APP_VERSION</string>
    <key>CFBundleShortVersionString</key>
    <string>$APP_VERSION</string>
    <key>CFBundleIconFile</key>
    <string>AppIcon</string>
    <key>CFBundleDevelopmentRegion</key>
    <string>en</string>
    <key>LSMinimumSystemVersion</key>
    <string>10.15.0</string>
    <key>NSHumanReadableCopyright</key>
    <string>Copyright Â© 2025 Alex</string>
    <key>NSHighResolutionCapable</key>
    <true/>
    <key>NSRequiresAquaSystemAppearance</key>
    <true/>
</dict>
</plist>
EOF

echo "APPL????" > "$CONTENTS_DIR/PkgInfo"

echo "Application successfully created: $APP_DIR"
echo "Size: $(du -sh "$APP_DIR" | cut -f1)"